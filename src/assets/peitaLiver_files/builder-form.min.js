"use strict";!function(){function e(){try{y.dispatch(y.actionTypes.CHANGE_PERSONA_FORM,m)}catch(e){console.error("builder-combo.saveState",e)}}function r(r){try{var u=r.target,i=u.getAttribute("builder-input-sku"),n=u.getAttribute("builder-input-step"),l=y.getState(["pdp","persona","builder","builderJson","steps"]),d=!1;l[n-1].multiOptions?(d=t(n),window.freedom.nsPubSub.pub("builder.builder-form.step.validate",d),e()):window.freedom.nsPubSub.pub("builder.builder-form.step.validate",o(i,n))}catch(a){console.error("builder.slider.validateInputByEvent",a)}}function t(e){var r=!1;try{var t,u=document.querySelectorAll('[builder-input][builder-input-step="'+e+'"]'),i=document.querySelectorAll('[builder-input-slider][builder-input-step="'+e+'"]:checked'),n=[],l=0;for(u=window.freedom.nodeListToArray(u),i=window.freedom.nodeListToArray(i),n=u.concat(i),l=n.length;l--;)t=n[l].getAttribute("builder-input-sku"),o(t,e)?(r=!0,m.validFields[t]=!0):m.validFields[t]=!1}catch(d){console.error("builder.slider.validateInputByEvent",d)}finally{return r}}function u(e){try{var r=e.target,t=r.value,u=r.getAttribute("builder-combo-step");"no-persona"===t?window.freedom.nsPubSub.pub("builder.builder-form.step.validate",!0):window.freedom.nsPubSub.pub("builder.builder-form.step.validate",o(t,u))}catch(i){console.error("builder.slider.validateInputByEvent",i)}}function o(e,r){try{var t=d(e,r);return!!t&&(!(!t.value||""===t.value.trim)&&!(t.color&&!t.color.code))}catch(u){return console.error("builder-form.getPersonaObjectByInputEl",u),!0}}function i(e,r,t){try{var u='[builder-input-step="'+e+'"]';return u+='[builder-input-sku="'+r+'"]',u+=t||""}catch(o){return console.error("builder-form.getPersonaObjectByInputEl",o),""}}function n(e){var r={};try{if(e){var t=e.getAttribute("builder-input-sku"),u=e.getAttribute("builder-input-step"),o=e.getAttribute("builder-input-image"),i=l(t,u);r.sku=t,r.value=e.value,o&&(r.imageValue=o),i&&(r.color=i)}}catch(n){console.error("builder-form.getPersonaObjectByInputEl",n)}finally{return r}}function l(e,r){var t={};try{var u,o=i(r,e,'[builder-input-attribute="color"]:checked'),n=i(r,e,'[builder-input-attribute="color"]'),l=!!document.querySelector(n);l?(u=document.querySelector(o),u&&(t.code=u.value,t.hexa=u.getAttribute("builder-input-color-hexa"),t.name=u.getAttribute("builder-input-color-name"))):t=null}catch(d){console.error("builder-form.getPersonaColor",d)}finally{return t}}function d(r,t){var u=null;try{var o=i(t,r),l=document.querySelector(o),d=l?l.type:"";switch(d){case"radio":o=i(t,r,":checked"),u=n(document.querySelector(o)),m.currField=Object.assign({},u,{type:"radio"}),e();break;case"text":u=n(l),m.currField=Object.assign({},u,{type:"text"}),e()}}catch(a){console.error("builder-form.getPersonaValue",a)}finally{return u}}function a(e){var r=[];try{if(f.personaOpened)for(var t,u,o,i,n,l=y.getState(["pdp","persona","builder","builderJson","steps"]),a=y.getState(["pdp","persona","builder"]).totalSteps;a--;)u=a+1,l[a].multiOptions?r=c(u):(n=document.querySelector('[builder-combo-select][builder-combo-step="'+u+'"]'),u=n.getAttribute("builder-combo-step"),o=n.value,t=d(o,u),i=s(u),t&&(Object.assign(t,i),r.push(t)))}catch(b){console.error("builder-form.getPersonaList",b)}finally{return e&&e(r,!0),r}}function c(e){var r=[];try{var t,u,o,i=document.querySelectorAll('[builder-input][builder-input-step="'+e+'"]'),n=document.querySelectorAll('[builder-input-slider][builder-input-step="'+e+'"]:checked'),l=[],a=0,c="";for(i=window.freedom.nodeListToArray(i),n=window.freedom.nodeListToArray(n),l=i.concat(n),a=l.length;a--;)t=l[a].getAttribute("builder-input-sku"),c=l[a].getAttribute("builder-input-name"),u=d(t,e),o=s(e),u&&""!==u.value.trim()&&(Object.assign(u,o,{label:c}),r.push(u))}catch(b){console.error("builder-form.getMultOptionsPersonaList",b)}finally{return r}}function s(e){var r={};try{var t=y.getState().pdp.persona.builder.builderJson,u=t.steps[e-1];u&&(r.cartImage=u.cartImage,r.productType=u.productType,r.label=u.label)}catch(o){console.error("builder-form.getPersonaList",o)}finally{return r}}function b(e){try{f.personaOpened=e}catch(r){console.error("builder-form.changePersonaOpenStatus",r)}}function p(){try{if(f.personaOpened){var e={list:a(),state:f.personaOpened};y.dispatch(y.actionTypes.CHANGE_SELECTED_PERSONA_BUILDER,e)}else y.dispatch(y.actionTypes.CHANGE_SELECTED_PERSONA_BUILDER,{})}catch(r){console.error("builder-combo.saveState",r)}}var f={personaOpened:!1},m={currField:"",validFields:{}},y=window.freedom.NsStore;window.freedom.nsPubSub.sub("colorFlavorSize.size.buyEvent",p),window.freedom.nsPubSub.sub("personalization.form.changeOpenClosed",b),window.freedom.nsPubSub.sub("builder.builder-combo.changed",u),window.freedom.nsPubSub.sub("builder.color-radio.changed",r),window.freedom.nsPubSub.sub("builder.slider.changed",r),window.freedom.nsPubSub.sub("builder.input.inputed",r),window.freedom.nsPubSub.sub("builder.personalization.get",a)}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIl9yZWZhY3RvcmluZy9fdGVtcGxhdGVzL3BlcnNvbmFsaXphdGlvbi9idWlsZGVyL2J1aWxkZXItZm9ybS9hbGwvYnVpbGRlci1mb3JtLm1pbi5qcyJdLCJuYW1lcyI6WyJ1cGRhdGVTdG9yZSIsInN0b3JlIiwiZGlzcGF0Y2giLCJhY3Rpb25UeXBlcyIsIkNIQU5HRV9QRVJTT05BX0ZPUk0iLCJmb3JtU3RhdGUiLCJlcnJvciIsImNvbnNvbGUiLCJ2YWxpZGF0ZUlucHV0QnlFdmVudCIsImV2ZW50IiwiaW5wdXQiLCJ0YXJnZXQiLCJza3UiLCJnZXRBdHRyaWJ1dGUiLCJzdGVwIiwic3RlcHMiLCJnZXRTdGF0ZSIsInZhbGlkIiwibXVsdGlPcHRpb25zIiwidmFsaWRhdGVBbGxGaWVsZCIsIndpbmRvdyIsImZyZWVkb20iLCJuc1B1YlN1YiIsInB1YiIsInZhbGlkYXRlUGVyc29uYSIsInN0ZXBJbnB1dHMiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJzdGVwUmFkaW9zIiwiaW5wdXRzIiwieCIsIm5vZGVMaXN0VG9BcnJheSIsImNvbmNhdCIsImxlbmd0aCIsInZhbGlkRmllbGRzIiwidmFsaWRhdGVTZWxlY3RCeUV2ZW50IiwidmFsdWUiLCJwZXJzb25hT2JqIiwiZ2V0UGVyc29uYVZhbHVlIiwidHJpbSIsImNvbG9yIiwiY29kZSIsImdldElucHV0UGVyc29uYVF1ZXJ5IiwiYWRpdGlvbmFsUXVlcnkiLCJxdWVyeSIsImdldFBlcnNvbmFPYmplY3RCeUlucHV0RWwiLCJlbGVtZW50IiwiaW1hZ2UiLCJnZXRQZXJzb25hQ29sb3IiLCJwZXJzb25hQ29sb3IiLCJzZWxlY3RlZENvbG9yIiwic2VsZWN0ZWRDb2xvclF1ZXJ5IiwiaGFzQ29sb3JRdWVyeSIsImhhc0NvbG9yIiwicXVlcnlTZWxlY3RvciIsInBlcnNvbmFFbCIsInR5cGUiLCJjdXJyRmllbGQiLCJPYmplY3QiLCJhc3NpZ24iLCJnZXRQZXJzb25hTGlzdCIsImNhbGxiYWNrIiwicGVyc29uYUxpc3QiLCJzdGF0ZSIsInBlcnNvbmFPcGVuZWQiLCJhZGRJbmZvIiwic2VsZWN0RWwiLCJpIiwidG90YWxTdGVwcyIsImdldE11bHRPcHRpb25zUGVyc29uYUxpc3QiLCJnZXRBZGRpdGlvbmFsSW5mb3JtYXRpb24iLCJwdXNoIiwibmFtZSIsImxhYmVsIiwiYWRkaXRpb25hbE9iaiIsImJ1aWxkZXIiLCJwZHAiLCJwZXJzb25hIiwiYnVpbGRlckpzb24iLCJzdGVwSnNvbiIsImNhcnRJbWFnZSIsInByb2R1Y3RUeXBlIiwiY2hhbmdlUGVyc29uYU9wZW5TdGF0dXMiLCJzdGF0dXMiLCJzYXZlU2VsZWN0ZWRQZXJzb25hIiwicGVyc29uYVN0YXRlIiwibGlzdCIsIkNIQU5HRV9TRUxFQ1RFRF9QRVJTT05BX0JVSUxERVIiLCJOc1N0b3JlIiwic3ViIl0sIm1hcHBpbmdzIjoiQUFBQSxjQUVDLFdBZUMsUUFBU0EsS0FDUCxJQUNFQyxFQUFNQyxTQUFTRCxFQUFNRSxZQUFZQyxvQkFBcUJDLEdBQ3RELE1BQU9DLEdBQ1BDLFFBQVFELE1BQU0sMEJBQTJCQSxJQVE3QyxRQUFTRSxHQUFxQkMsR0FDNUIsSUFDRSxHQUFJQyxHQUFRRCxFQUFNRSxPQUNkQyxFQUFNRixFQUFNRyxhQUFhLHFCQUN6QkMsRUFBT0osRUFBTUcsYUFBYSxzQkFDMUJFLEVBQVFkLEVBQU1lLFVBQVUsTUFBTyxVQUFXLFVBQVcsY0FBZSxVQUNwRUMsR0FBUSxDQUVURixHQUFNRCxFQUFPLEdBQUdJLGNBQ2pCRCxFQUFRRSxFQUFpQkwsR0FDekJNLE9BQU9DLFFBQVFDLFNBQVNDLElBQUkscUNBQXNDTixHQUNsRWpCLEtBRUFvQixPQUFPQyxRQUFRQyxTQUFTQyxJQUFJLHFDQUFzQ0MsRUFBZ0JaLEVBQUtFLElBRXpGLE1BQU9SLEdBQ1BDLFFBQVFELE1BQU0sc0NBQXVDQSxJQVN6RCxRQUFTYSxHQUFpQkwsR0FDeEIsR0FBSUcsSUFBUSxDQUNaLEtBRUUsR0FJRUwsR0FKRWEsRUFBYUMsU0FBU0MsaUJBQWlCLHVDQUF5Q2IsRUFBTyxNQUN6RmMsRUFBYUYsU0FBU0MsaUJBQWlCLDhDQUFnRGIsRUFBTyxjQUM5RmUsS0FDQUMsRUFBSSxDQVNOLEtBTkFMLEVBQWFMLE9BQU9DLFFBQVFVLGdCQUFnQk4sR0FDNUNHLEVBQWFSLE9BQU9DLFFBQVFVLGdCQUFnQkgsR0FFNUNDLEVBQVNKLEVBQVdPLE9BQU9KLEdBQzNCRSxFQUFJRCxFQUFPSSxPQUVMSCxLQUNKbEIsRUFBTWlCLEVBQU9DLEdBQUdqQixhQUFhLHFCQUMxQlcsRUFBZ0JaLEVBQUtFLElBQ3RCRyxHQUFRLEVBQ1JaLEVBQVU2QixZQUFZdEIsSUFBTyxHQUU3QlAsRUFBVTZCLFlBQVl0QixJQUFPLEVBR2pDLE1BQU9OLEdBQ1BDLFFBQVFELE1BQU0sc0NBQXVDQSxHQUNyRCxRQUNBLE1BQU9XLElBUVgsUUFBU2tCLEdBQXNCMUIsR0FDN0IsSUFDRSxHQUFJQyxHQUFRRCxFQUFNRSxPQUNkeUIsRUFBUTFCLEVBQU0wQixNQUNkdEIsRUFBT0osRUFBTUcsYUFBYSxxQkFFakIsZ0JBQVZ1QixFQUNEaEIsT0FBT0MsUUFBUUMsU0FBU0MsSUFBSSxzQ0FBc0MsR0FFbEVILE9BQU9DLFFBQVFDLFNBQVNDLElBQUkscUNBQXNDQyxFQUFnQlksRUFBT3RCLElBRTNGLE1BQU9SLEdBQ1BDLFFBQVFELE1BQU0sc0NBQXVDQSxJQVV6RCxRQUFTa0IsR0FBZ0JaLEVBQUtFLEdBQzVCLElBQ0UsR0FBSXVCLEdBQWFDLEVBQWdCMUIsRUFBS0UsRUFFdEMsU0FBSXVCLE9BRUFBLEVBQVdELE9BQW1DLEtBQTFCQyxFQUFXRCxNQUFNRyxTQUV0Q0YsRUFBV0csUUFBVUgsRUFBV0csTUFBTUMsT0FHekMsTUFBT25DLEdBRVAsTUFEQUMsU0FBUUQsTUFBTSx5Q0FBMENBLElBQ2pELEdBVVgsUUFBU29DLEdBQXFCNUIsRUFBTUYsRUFBSytCLEdBQ3ZDLElBQ0UsR0FBSUMsR0FBUSx3QkFBMEI5QixFQUFPLElBSTdDLE9BSEE4QixJQUFTLHVCQUF5QmhDLEVBQU0sS0FDeENnQyxHQUFTRCxHQUFrQixHQUkzQixNQUFPckMsR0FFUCxNQURBQyxTQUFRRCxNQUFNLHlDQUEwQ0EsR0FDakQsSUFRWCxRQUFTdUMsR0FBMEJDLEdBQ2pDLEdBQUlULEtBQ0osS0FDRSxHQUFHUyxFQUFTLENBQ1YsR0FBSWxDLEdBQU1rQyxFQUFRakMsYUFBYSxxQkFDM0JDLEVBQU9nQyxFQUFRakMsYUFBYSxzQkFDNUJrQyxFQUFRRCxFQUFRakMsYUFBYSx1QkFDN0IyQixFQUFRUSxFQUFnQnBDLEVBQUtFLEVBRWpDdUIsR0FBZ0IsSUFBSXpCLEVBQ3BCeUIsRUFBa0IsTUFBSVMsRUFBUVYsTUFFM0JXLElBQU9WLEVBQXVCLFdBQUlVLEdBQ2xDUCxJQUFPSCxFQUFrQixNQUFJRyxJQUVsQyxNQUFPbEMsR0FDUEMsUUFBUUQsTUFBTSx5Q0FBMENBLEdBQ3hELFFBQ0EsTUFBTytCLElBUVgsUUFBU1csR0FBZ0JwQyxFQUFLRSxHQUM1QixHQUFJbUMsS0FDSixLQUNFLEdBR0lDLEdBSEFDLEVBQXFCVCxFQUFxQjVCLEVBQU1GLEVBQUssNkNBQ3JEd0MsRUFBZ0JWLEVBQXFCNUIsRUFBTUYsRUFBSyxxQ0FDaER5QyxJQUFjM0IsU0FBUzRCLGNBQWNGLEVBR3RDQyxJQUNESCxFQUFpQnhCLFNBQVM0QixjQUFjSCxHQUVyQ0QsSUFDREQsRUFBbUIsS0FBSUMsRUFBY2QsTUFDckNhLEVBQW1CLEtBQUlDLEVBQWNyQyxhQUFhLDRCQUNsRG9DLEVBQW1CLEtBQUlDLEVBQWNyQyxhQUFhLDhCQUdwRG9DLEVBQWUsS0FHakIsTUFBTzNDLEdBQ1BDLFFBQVFELE1BQU0sK0JBQWdDQSxHQUM5QyxRQUNBLE1BQU8yQyxJQVVYLFFBQVNYLEdBQWdCMUIsRUFBS0UsR0FDNUIsR0FBSXVCLEdBQWEsSUFDakIsS0FDRSxHQUFJTyxHQUFRRixFQUFxQjVCLEVBQU1GLEdBQ25DMkMsRUFBWTdCLFNBQVM0QixjQUFjVixHQUVuQ1ksRUFBT0QsRUFBWUEsRUFBVUMsS0FBTyxFQUN4QyxRQUFPQSxHQUNMLElBQUssUUFDSFosRUFBUUYsRUFBcUI1QixFQUFNRixFQUFLLFlBQ3hDeUIsRUFBYVEsRUFBMEJuQixTQUFTNEIsY0FBY1YsSUFDOUR2QyxFQUFVb0QsVUFBWUMsT0FBT0MsVUFBV3RCLEdBQWFtQixLQUFNLFVBQzNEeEQsR0FDQSxNQUVGLEtBQUssT0FDSHFDLEVBQWFRLEVBQTBCVSxHQUN2Q2xELEVBQVVvRCxVQUFZQyxPQUFPQyxVQUFXdEIsR0FBYW1CLEtBQU0sU0FDM0R4RCxLQU9KLE1BQU9NLEdBQ1BDLFFBQVFELE1BQU0sK0JBQWdDQSxHQUM5QyxRQUNBLE1BQU8rQixJQVFYLFFBQVN1QixHQUFlQyxHQUN0QixHQUFJQyxLQUNKLEtBQ0UsR0FBR0MsRUFBTUMsY0FTUCxJQVJBLEdBRUkzQixHQUNBdkIsRUFDQUYsRUFDQXFELEVBQ0FDLEVBTkFuRCxFQUFRZCxFQUFNZSxVQUFVLE1BQU8sVUFBVyxVQUFXLGNBQWUsVUFDcEVtRCxFQUFJbEUsRUFBTWUsVUFBVSxNQUFPLFVBQVcsWUFBWW9ELFdBT2hERCxLQUNKckQsRUFBT3FELEVBQUksRUFFUnBELEVBQU1vRCxHQUFHakQsYUFDVjRDLEVBQWNPLEVBQTBCdkQsSUFFeENvRCxFQUFXeEMsU0FBUzRCLGNBQWMsOENBQWdEeEMsRUFBTyxNQUN6RkEsRUFBT29ELEVBQVNyRCxhQUFhLHNCQUM3QkQsRUFBTXNELEVBQVM5QixNQUNmQyxFQUFhQyxFQUFnQjFCLEVBQUtFLEdBQ2xDbUQsRUFBVUssRUFBeUJ4RCxHQUVoQ3VCLElBQ0RxQixPQUFPQyxPQUFPdEIsRUFBWTRCLEdBQzFCSCxFQUFZUyxLQUFLbEMsS0FLekIsTUFBTy9CLEdBQ1BDLFFBQVFELE1BQU0sOEJBQStCQSxHQUM3QyxRQUtBLE1BSkd1RCxJQUNEQSxFQUFTQyxHQUFhLEdBR2pCQSxHQUlYLFFBQVNPLEdBQTBCdkQsR0FDakMsR0FBSWdELEtBQ0osS0FFRSxHQUtFbEQsR0FDQXlCLEVBQ0E0QixFQVBFeEMsRUFBYUMsU0FBU0MsaUJBQWlCLHVDQUF5Q2IsRUFBTyxNQUN6RmMsRUFBYUYsU0FBU0MsaUJBQWlCLDhDQUFnRGIsRUFBTyxjQUM5RmUsS0FDQUMsRUFBSSxFQUNKMEMsRUFBTyxFQVdULEtBTkEvQyxFQUFhTCxPQUFPQyxRQUFRVSxnQkFBZ0JOLEdBQzVDRyxFQUFhUixPQUFPQyxRQUFRVSxnQkFBZ0JILEdBRTVDQyxFQUFTSixFQUFXTyxPQUFPSixHQUMzQkUsRUFBSUQsRUFBT0ksT0FFTEgsS0FDSmxCLEVBQU1pQixFQUFPQyxHQUFHakIsYUFBYSxxQkFDN0IyRCxFQUFPM0MsRUFBT0MsR0FBR2pCLGFBQWEsc0JBRTlCd0IsRUFBYUMsRUFBZ0IxQixFQUFLRSxHQUNsQ21ELEVBQVVLLEVBQXlCeEQsR0FFaEN1QixHQUEwQyxLQUE1QkEsRUFBV0QsTUFBTUcsU0FDaENtQixPQUFPQyxPQUFPdEIsRUFBWTRCLEdBQVVRLE1BQU9ELElBQzNDVixFQUFZUyxLQUFLbEMsSUFHckIsTUFBTy9CLEdBQ1BDLFFBQVFELE1BQU0seUNBQTBDQSxHQUN4RCxRQUNBLE1BQU93RCxJQVNYLFFBQVNRLEdBQXlCeEQsR0FDaEMsR0FBSTRELEtBQ0osS0FDRSxHQUFJQyxHQUFVMUUsRUFBTWUsV0FBVzRELElBQUlDLFFBQVFGLFFBQVFHLFlBQy9DQyxFQUFXSixFQUFRNUQsTUFBTUQsRUFBTyxFQUVqQ2lFLEtBQ0RMLEVBQXlCLFVBQUlLLEVBQVNDLFVBQ3RDTixFQUEyQixZQUFJSyxFQUFTRSxZQUN4Q1AsRUFBcUIsTUFBSUssRUFBU04sT0FFcEMsTUFBT25FLEdBQ1BDLFFBQVFELE1BQU0sOEJBQStCQSxHQUM3QyxRQUNBLE1BQU9vRSxJQVFYLFFBQVNRLEdBQXdCQyxHQUMvQixJQUNFcEIsRUFBTUMsY0FBZ0JtQixFQUN0QixNQUFPN0UsR0FDUEMsUUFBUUQsTUFBTSx1Q0FBd0NBLElBTzFELFFBQVM4RSxLQUNQLElBQ0UsR0FBR3JCLEVBQU1DLGNBQWUsQ0FDdEIsR0FBSXFCLElBQ0ZDLEtBQU0xQixJQUNORyxNQUFPQSxFQUFNQyxjQUdmL0QsR0FBTUMsU0FBU0QsRUFBTUUsWUFBWW9GLGdDQUFpQ0YsT0FFbEVwRixHQUFNQyxTQUFTRCxFQUFNRSxZQUFZb0Ysb0NBRW5DLE1BQU9qRixHQUNQQyxRQUFRRCxNQUFNLDBCQUEyQkEsSUF4WDdDLEdBQUl5RCxJQUNGQyxlQUFlLEdBR2IzRCxHQUNGb0QsVUFBVSxHQUNWdkIsZ0JBR0VqQyxFQUFRbUIsT0FBT0MsUUFBUW1FLE9BbVgzQnBFLFFBQU9DLFFBQVFDLFNBQVNtRSxJQUFJLGdDQUFpQ0wsR0FDN0RoRSxPQUFPQyxRQUFRQyxTQUFTbUUsSUFBSSx3Q0FBeUNQLEdBQ3JFOUQsT0FBT0MsUUFBUUMsU0FBU21FLElBQUksZ0NBQWlDdEQsR0FDN0RmLE9BQU9DLFFBQVFDLFNBQVNtRSxJQUFJLDhCQUErQmpGLEdBQzNEWSxPQUFPQyxRQUFRQyxTQUFTbUUsSUFBSSx5QkFBMEJqRixHQUN0RFksT0FBT0MsUUFBUUMsU0FBU21FLElBQUksd0JBQXlCakYsR0FDckRZLE9BQU9DLFFBQVFDLFNBQVNtRSxJQUFJLDhCQUErQjdCIiwiZmlsZSI6Il9yZWZhY3RvcmluZy9fdGVtcGxhdGVzL3BlcnNvbmFsaXphdGlvbi9idWlsZGVyL2J1aWxkZXItZm9ybS9hbGwvYnVpbGRlci1mb3JtLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuKGZ1bmN0aW9uKCl7XG4gIHZhciBzdGF0ZSA9IHtcbiAgICBwZXJzb25hT3BlbmVkOiBmYWxzZVxuICB9O1xuXG4gIHZhciBmb3JtU3RhdGUgPSB7XG4gICAgY3VyckZpZWxkOicnLFxuICAgIHZhbGlkRmllbGRzOiB7fVxuICB9O1xuXG4gIHZhciBzdG9yZSA9IHdpbmRvdy5mcmVlZG9tLk5zU3RvcmU7XG5cbiAgLyoqXG4gICAqIGZ1bmN0aW9uIHRvIGRpc3BhdGNoIGxvY2FsIHN0YXRlIHRvIHN0b3JlXG4gICAqL1xuICBmdW5jdGlvbiB1cGRhdGVTdG9yZSgpIHtcbiAgICB0cnkge1xuICAgICAgc3RvcmUuZGlzcGF0Y2goc3RvcmUuYWN0aW9uVHlwZXMuQ0hBTkdFX1BFUlNPTkFfRk9STSwgZm9ybVN0YXRlKTsgLy9kaXNwYXRjaCB0byBzdGF0ZVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdidWlsZGVyLWNvbWJvLnNhdmVTdGF0ZScsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gdmFsaWRhdGUgdGhlIGVzcGVjaWZpYyBpbnB1dCBieSBldmVudFxuICAgKiBAcGFyYW0ge29iamVjdH0gZXZlbnQgLSBldmVudCBvZiBpbnB1dFxuICAgKi9cbiAgZnVuY3Rpb24gdmFsaWRhdGVJbnB1dEJ5RXZlbnQoZXZlbnQpIHtcbiAgICB0cnkge1xuICAgICAgdmFyIGlucHV0ID0gZXZlbnQudGFyZ2V0XG4gICAgICAgICwgc2t1ID0gaW5wdXQuZ2V0QXR0cmlidXRlKCdidWlsZGVyLWlucHV0LXNrdScpXG4gICAgICAgICwgc3RlcCA9IGlucHV0LmdldEF0dHJpYnV0ZSgnYnVpbGRlci1pbnB1dC1zdGVwJylcbiAgICAgICAgLCBzdGVwcyA9IHN0b3JlLmdldFN0YXRlKFsncGRwJywgJ3BlcnNvbmEnLCAnYnVpbGRlcicsICdidWlsZGVySnNvbicsICdzdGVwcyddKVxuICAgICAgICAsIHZhbGlkID0gZmFsc2U7XG5cbiAgICAgIGlmKHN0ZXBzW3N0ZXAgLSAxXS5tdWx0aU9wdGlvbnMpIHtcbiAgICAgICAgdmFsaWQgPSB2YWxpZGF0ZUFsbEZpZWxkKHN0ZXApO1xuICAgICAgICB3aW5kb3cuZnJlZWRvbS5uc1B1YlN1Yi5wdWIoJ2J1aWxkZXIuYnVpbGRlci1mb3JtLnN0ZXAudmFsaWRhdGUnLCB2YWxpZCk7XG4gICAgICAgIHVwZGF0ZVN0b3JlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3aW5kb3cuZnJlZWRvbS5uc1B1YlN1Yi5wdWIoJ2J1aWxkZXIuYnVpbGRlci1mb3JtLnN0ZXAudmFsaWRhdGUnLCB2YWxpZGF0ZVBlcnNvbmEoc2t1LCBzdGVwKSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2J1aWxkZXIuc2xpZGVyLnZhbGlkYXRlSW5wdXRCeUV2ZW50JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBmdW5jdGlvbiB0byB2YWxpZGF0ZSBhbGwgaW5wdXRzIG9mIG9uZSBzdGVwXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBzdGVwIHN0ZXAgbnVtYmVyIHRvIHZhbGlkYXRlXG4gICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgKi9cbiAgZnVuY3Rpb24gdmFsaWRhdGVBbGxGaWVsZChzdGVwKSB7XG4gICAgdmFyIHZhbGlkID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIC8vZ2V0IGFsbCBpbnB1dHMgb2YgdGhlIHNhbWUgc3RlcCAobXVsdGlPcHRpb25zIHN0ZXApXG4gICAgICB2YXIgc3RlcElucHV0cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tidWlsZGVyLWlucHV0XVtidWlsZGVyLWlucHV0LXN0ZXA9XCInICsgc3RlcCArICdcIl0nKVxuICAgICAgLCBzdGVwUmFkaW9zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2J1aWxkZXItaW5wdXQtc2xpZGVyXVtidWlsZGVyLWlucHV0LXN0ZXA9XCInICsgc3RlcCArICdcIl06Y2hlY2tlZCcpXG4gICAgICAsIGlucHV0cyA9IFtdXG4gICAgICAsIHggPSAwXG4gICAgICAsIHNrdTtcblxuICAgICAgc3RlcElucHV0cyA9IHdpbmRvdy5mcmVlZG9tLm5vZGVMaXN0VG9BcnJheShzdGVwSW5wdXRzKTtcbiAgICAgIHN0ZXBSYWRpb3MgPSB3aW5kb3cuZnJlZWRvbS5ub2RlTGlzdFRvQXJyYXkoc3RlcFJhZGlvcyk7XG5cbiAgICAgIGlucHV0cyA9IHN0ZXBJbnB1dHMuY29uY2F0KHN0ZXBSYWRpb3MpO1xuICAgICAgeCA9IGlucHV0cy5sZW5ndGg7XG5cbiAgICAgIHdoaWxlKHgtLSkge1xuICAgICAgICBza3UgPSBpbnB1dHNbeF0uZ2V0QXR0cmlidXRlKCdidWlsZGVyLWlucHV0LXNrdScpO1xuICAgICAgICBpZih2YWxpZGF0ZVBlcnNvbmEoc2t1LCBzdGVwKSkgeyAvL2lmIG9uZSBvZiBhbGwgaXMgdmFsaWQgdGhlIHN0ZXAgaXMgdmFsaWRcbiAgICAgICAgICB2YWxpZCA9IHRydWU7XG4gICAgICAgICAgZm9ybVN0YXRlLnZhbGlkRmllbGRzW3NrdV0gPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZvcm1TdGF0ZS52YWxpZEZpZWxkc1tza3VdID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignYnVpbGRlci5zbGlkZXIudmFsaWRhdGVJbnB1dEJ5RXZlbnQnLCBlcnJvcik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHJldHVybiB2YWxpZDtcbiAgICB9XG4gIH1cblxuICAgIC8qKlxuICAgKiBmdW5jdGlvbiB0byB2YWxpZGF0ZSB0aGUgZXNwZWNpZmljIGlucHV0IGJ5IGV2ZW50XG4gICAqIEBwYXJhbSB7b2JqZWN0fSBldmVudCAtIGV2ZW50IG9mIGlucHV0XG4gICAqL1xuICBmdW5jdGlvbiB2YWxpZGF0ZVNlbGVjdEJ5RXZlbnQoZXZlbnQpIHtcbiAgICB0cnkge1xuICAgICAgdmFyIGlucHV0ID0gZXZlbnQudGFyZ2V0XG4gICAgICAgICwgdmFsdWUgPSBpbnB1dC52YWx1ZSAvL2dldCB2YWx1ZSBwZXJzb25hIFNLVSBvciBuby1wZXJzb25hXG4gICAgICAgICwgc3RlcCA9IGlucHV0LmdldEF0dHJpYnV0ZSgnYnVpbGRlci1jb21iby1zdGVwJyk7XG5cbiAgICAgIGlmKHZhbHVlID09PSAnbm8tcGVyc29uYScpIHsgLy9pZiBubyBwZXJzb25hIHNlbGVjdGVkIGl0cyB0cnVlXG4gICAgICAgIHdpbmRvdy5mcmVlZG9tLm5zUHViU3ViLnB1YignYnVpbGRlci5idWlsZGVyLWZvcm0uc3RlcC52YWxpZGF0ZScsIHRydWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2luZG93LmZyZWVkb20ubnNQdWJTdWIucHViKCdidWlsZGVyLmJ1aWxkZXItZm9ybS5zdGVwLnZhbGlkYXRlJywgdmFsaWRhdGVQZXJzb25hKHZhbHVlLCBzdGVwKSk7IC8vbm90aWZ5IHRydWUvZmFsc2VcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignYnVpbGRlci5zbGlkZXIudmFsaWRhdGVJbnB1dEJ5RXZlbnQnLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIGZ1bmN0aW9uIHRvIHZhbGlkYXRlIHNwZWNpZmljIHBlcnNvbmFcbiAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXAgLSBzdGVwIHRvIHZhbGlkYXRlIHRoZSBpbmZvcm1hdGlvbnNcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNrdSAtIHNrdSBvZiBwZXJzb25hIHRvIHZhbGlkYXRlXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IC0gdmFsaWRhdGUgb2Ygc3RlcFxuICAgKi9cbiAgZnVuY3Rpb24gdmFsaWRhdGVQZXJzb25hKHNrdSwgc3RlcCkge1xuICAgIHRyeSB7XG4gICAgICB2YXIgcGVyc29uYU9iaiA9IGdldFBlcnNvbmFWYWx1ZShza3UsIHN0ZXApO1xuXG4gICAgICBpZighcGVyc29uYU9iaikgcmV0dXJuIGZhbHNlOyAvL2hhcyBhIHBlcnNvbmEgb2JqZWN0XG5cbiAgICAgIGlmKCFwZXJzb25hT2JqLnZhbHVlIHx8IHBlcnNvbmFPYmoudmFsdWUudHJpbSA9PT0gJycpIHJldHVybiBmYWxzZTsgLy9oYXMgcGVyc29uYSBzZWxlY3RlZFxuXG4gICAgICBpZihwZXJzb25hT2JqLmNvbG9yICYmICFwZXJzb25hT2JqLmNvbG9yLmNvZGUpIHJldHVybiBmYWxzZTsgLy9oYXMgY29sb3IgYW5kIGNvbG9yIHdhcyBzZWxlY3RlZFxuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignYnVpbGRlci1mb3JtLmdldFBlcnNvbmFPYmplY3RCeUlucHV0RWwnLCBlcnJvcik7XG4gICAgICByZXR1cm4gdHJ1ZTsvL2lmIGVycm9yIG9jdXJyIGFsbG93IHRoZSBidXlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gY3JlYXRlIGEgaW5wdXQgcXVlcnkgdG8gRE9NXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBza3UgcGVyc29uYSBza3VcbiAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXAgY3VycmVudCBzdGVwIG9mIHBlcnNvbmFcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFkaXRpb25hbFF1ZXJ5IGFkaXRpb25hbFF1ZXJ5IG9mIGlucHV0IHRvIGdldFxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0SW5wdXRQZXJzb25hUXVlcnkoc3RlcCwgc2t1LCBhZGl0aW9uYWxRdWVyeSkge1xuICAgIHRyeSB7XG4gICAgICB2YXIgcXVlcnkgPSAnW2J1aWxkZXItaW5wdXQtc3RlcD1cIicgKyBzdGVwICsgJ1wiXSc7IC8vcXVlcnkgdG8gZ2V0IHRoZSBpbnB1dCBwZXJzb25hIHZhbHVlXG4gICAgICBxdWVyeSArPSAnW2J1aWxkZXItaW5wdXQtc2t1PVwiJyArIHNrdSArICdcIl0nO1xuICAgICAgcXVlcnkgKz0gYWRpdGlvbmFsUXVlcnkgfHwgJyc7XG5cbiAgICAgIHJldHVybiBxdWVyeTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdidWlsZGVyLWZvcm0uZ2V0UGVyc29uYU9iamVjdEJ5SW5wdXRFbCcsIGVycm9yKTtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gZ2V0IHRoZSBwZXJzb25hIG9iamVjdCBieSBhIGlucHV0IHBlcnNvbmEgRWxlbWVudFxuICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgcGVyc29uYSBpbnB1dCBlbGVtZW50XG4gICAqL1xuICBmdW5jdGlvbiBnZXRQZXJzb25hT2JqZWN0QnlJbnB1dEVsKGVsZW1lbnQpIHtcbiAgICB2YXIgcGVyc29uYU9iaiA9IHt9O1xuICAgIHRyeSB7XG4gICAgICBpZihlbGVtZW50KSB7XG4gICAgICAgIHZhciBza3UgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnYnVpbGRlci1pbnB1dC1za3UnKVxuICAgICAgICAgICwgc3RlcCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdidWlsZGVyLWlucHV0LXN0ZXAnKVxuICAgICAgICAgICwgaW1hZ2UgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnYnVpbGRlci1pbnB1dC1pbWFnZScpXG4gICAgICAgICAgLCBjb2xvciA9IGdldFBlcnNvbmFDb2xvcihza3UsIHN0ZXApO1xuXG4gICAgICAgIHBlcnNvbmFPYmpbJ3NrdSddID0gc2t1O1xuICAgICAgICBwZXJzb25hT2JqWyd2YWx1ZSddID0gZWxlbWVudC52YWx1ZTtcblxuICAgICAgICBpZihpbWFnZSkgcGVyc29uYU9ialsnaW1hZ2VWYWx1ZSddID0gaW1hZ2U7XG4gICAgICAgIGlmKGNvbG9yKSBwZXJzb25hT2JqWydjb2xvciddID0gY29sb3I7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2J1aWxkZXItZm9ybS5nZXRQZXJzb25hT2JqZWN0QnlJbnB1dEVsJywgZXJyb3IpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICByZXR1cm4gcGVyc29uYU9iajtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gZ2V0IHRoZSBwZXJzb25hbGl6YXRpb24gY29sb3Igc2VsZWN0ZWRcbiAgICogQHJldHVybiB7b2JqZWN0fSBjb2xvciBvYmplY3RcbiAgICovXG4gIGZ1bmN0aW9uIGdldFBlcnNvbmFDb2xvcihza3UsIHN0ZXApIHtcbiAgICB2YXIgcGVyc29uYUNvbG9yID0ge307XG4gICAgdHJ5IHtcbiAgICAgIHZhciBzZWxlY3RlZENvbG9yUXVlcnkgPSBnZXRJbnB1dFBlcnNvbmFRdWVyeShzdGVwLCBza3UsICdbYnVpbGRlci1pbnB1dC1hdHRyaWJ1dGU9XCJjb2xvclwiXTpjaGVja2VkJylcbiAgICAgICAgLCBoYXNDb2xvclF1ZXJ5ID0gZ2V0SW5wdXRQZXJzb25hUXVlcnkoc3RlcCwgc2t1LCAnW2J1aWxkZXItaW5wdXQtYXR0cmlidXRlPVwiY29sb3JcIl0nKS8vZmluZCBjb2xvciBhc3NvY2lhdGVkIHRvIHBlcnNvbmFcbiAgICAgICAgLCBoYXNDb2xvciA9ICEhIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoaGFzQ29sb3JRdWVyeSlcbiAgICAgICAgLCBzZWxlY3RlZENvbG9yO1xuXG4gICAgICBpZihoYXNDb2xvcikge1xuICAgICAgICBzZWxlY3RlZENvbG9yID0gIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0ZWRDb2xvclF1ZXJ5KTtcblxuICAgICAgICBpZihzZWxlY3RlZENvbG9yKSB7XG4gICAgICAgICAgcGVyc29uYUNvbG9yWydjb2RlJ10gPSBzZWxlY3RlZENvbG9yLnZhbHVlO1xuICAgICAgICAgIHBlcnNvbmFDb2xvclsnaGV4YSddID0gc2VsZWN0ZWRDb2xvci5nZXRBdHRyaWJ1dGUoJ2J1aWxkZXItaW5wdXQtY29sb3ItaGV4YScpO1xuICAgICAgICAgIHBlcnNvbmFDb2xvclsnbmFtZSddID0gc2VsZWN0ZWRDb2xvci5nZXRBdHRyaWJ1dGUoJ2J1aWxkZXItaW5wdXQtY29sb3ItbmFtZScpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwZXJzb25hQ29sb3IgPSBudWxsOy8vaGF2ZSBubyBjb2xvcnMgdG8gc2VsZWN0XG4gICAgICB9XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignYnVpbGRlci1mb3JtLmdldFBlcnNvbmFDb2xvcicsIGVycm9yKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgcmV0dXJuIHBlcnNvbmFDb2xvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gZ2V0IHRoZSBwZXJzb25hIGRhdGEgYnkgc2t1IGFuZCBzdGVwXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBza3UgcGVyc29uYSBza3VcbiAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXAgY3VycmVudCBzdGVwIG9mIHBlcnNvbmFcbiAgICogQHJldHVybiB7b2JqZWN0fSBwZXJzb25hIG9iamVjdFxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0UGVyc29uYVZhbHVlKHNrdSwgc3RlcCkge1xuICAgIHZhciBwZXJzb25hT2JqID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgdmFyIHF1ZXJ5ID0gZ2V0SW5wdXRQZXJzb25hUXVlcnkoc3RlcCwgc2t1KTtcbiAgICAgIHZhciBwZXJzb25hRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHF1ZXJ5KTtcblxuICAgICAgdmFyIHR5cGUgPSBwZXJzb25hRWwgPyBwZXJzb25hRWwudHlwZSA6ICcnO1xuICAgICAgc3dpdGNoKHR5cGUpIHtcbiAgICAgICAgY2FzZSAncmFkaW8nOlxuICAgICAgICAgIHF1ZXJ5ID0gZ2V0SW5wdXRQZXJzb25hUXVlcnkoc3RlcCwgc2t1LCAnOmNoZWNrZWQnKTsgLy9nZXQgdGhlIHNlbGVjdGVkIGlucHV0XG4gICAgICAgICAgcGVyc29uYU9iaiA9IGdldFBlcnNvbmFPYmplY3RCeUlucHV0RWwoZG9jdW1lbnQucXVlcnlTZWxlY3RvcihxdWVyeSkpO1xuICAgICAgICAgIGZvcm1TdGF0ZS5jdXJyRmllbGQgPSBPYmplY3QuYXNzaWduKHt9LCBwZXJzb25hT2JqLCB7dHlwZTogJ3JhZGlvJ30pO1xuICAgICAgICAgIHVwZGF0ZVN0b3JlKCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAndGV4dCc6XG4gICAgICAgICAgcGVyc29uYU9iaiA9IGdldFBlcnNvbmFPYmplY3RCeUlucHV0RWwocGVyc29uYUVsKTtcbiAgICAgICAgICBmb3JtU3RhdGUuY3VyckZpZWxkID0gT2JqZWN0LmFzc2lnbih7fSwgcGVyc29uYU9iaiwge3R5cGU6ICd0ZXh0J30pO1xuICAgICAgICAgIHVwZGF0ZVN0b3JlKCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdidWlsZGVyLWZvcm0uZ2V0UGVyc29uYVZhbHVlJywgZXJyb3IpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICByZXR1cm4gcGVyc29uYU9iajtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gZ2V0IHBlcnNvbmEgbGlzdCBkYXRhXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIGZ1bmN0aW9uIHRvIHJlY2VpdmUgdGhlIHBlcnNvbmEgbGlzdFxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0UGVyc29uYUxpc3QoY2FsbGJhY2spIHtcbiAgICB2YXIgcGVyc29uYUxpc3QgPSBbXTtcbiAgICB0cnkge1xuICAgICAgaWYoc3RhdGUucGVyc29uYU9wZW5lZCkge1xuICAgICAgICB2YXIgc3RlcHMgPSBzdG9yZS5nZXRTdGF0ZShbJ3BkcCcsICdwZXJzb25hJywgJ2J1aWxkZXInLCAnYnVpbGRlckpzb24nLCAnc3RlcHMnXSlcbiAgICAgICAgICAsIGkgPSBzdG9yZS5nZXRTdGF0ZShbJ3BkcCcsICdwZXJzb25hJywgJ2J1aWxkZXInXSkudG90YWxTdGVwc1xuICAgICAgICAgICwgcGVyc29uYU9ialxuICAgICAgICAgICwgc3RlcFxuICAgICAgICAgICwgc2t1XG4gICAgICAgICAgLCBhZGRJbmZvXG4gICAgICAgICAgLCBzZWxlY3RFbDtcblxuICAgICAgICB3aGlsZShpLS0pIHtcbiAgICAgICAgICBzdGVwID0gaSArIDE7XG5cbiAgICAgICAgICBpZihzdGVwc1tpXS5tdWx0aU9wdGlvbnMpIHtcbiAgICAgICAgICAgIHBlcnNvbmFMaXN0ID0gZ2V0TXVsdE9wdGlvbnNQZXJzb25hTGlzdChzdGVwKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2VsZWN0RWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbYnVpbGRlci1jb21iby1zZWxlY3RdW2J1aWxkZXItY29tYm8tc3RlcD1cIicgKyBzdGVwICsgJ1wiXScpOyAvL2NvbWJvIG9mIHN0ZXBcbiAgICAgICAgICAgIHN0ZXAgPSBzZWxlY3RFbC5nZXRBdHRyaWJ1dGUoJ2J1aWxkZXItY29tYm8tc3RlcCcpO1xuICAgICAgICAgICAgc2t1ID0gc2VsZWN0RWwudmFsdWU7XG4gICAgICAgICAgICBwZXJzb25hT2JqID0gZ2V0UGVyc29uYVZhbHVlKHNrdSwgc3RlcCk7XG4gICAgICAgICAgICBhZGRJbmZvID0gZ2V0QWRkaXRpb25hbEluZm9ybWF0aW9uKHN0ZXApO1xuXG4gICAgICAgICAgICBpZihwZXJzb25hT2JqKSB7XG4gICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocGVyc29uYU9iaiwgYWRkSW5mbyk7IC8vbWVyZ2UgaW5mb3JtYXRpb25zXG4gICAgICAgICAgICAgIHBlcnNvbmFMaXN0LnB1c2gocGVyc29uYU9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2J1aWxkZXItZm9ybS5nZXRQZXJzb25hTGlzdCcsIGVycm9yKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgaWYoY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2socGVyc29uYUxpc3QsIHRydWUpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcGVyc29uYUxpc3Q7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZ2V0TXVsdE9wdGlvbnNQZXJzb25hTGlzdChzdGVwKSB7XG4gICAgdmFyIHBlcnNvbmFMaXN0ID0gW107XG4gICAgdHJ5IHtcbiAgICAgIC8vZ2V0IGFsbCBpbnB1dHMgb2YgdGhlIHNhbWUgc3RlcCAobXVsdGlPcHRpb25zIHN0ZXApXG4gICAgICB2YXIgc3RlcElucHV0cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tidWlsZGVyLWlucHV0XVtidWlsZGVyLWlucHV0LXN0ZXA9XCInICsgc3RlcCArICdcIl0nKVxuICAgICAgLCBzdGVwUmFkaW9zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2J1aWxkZXItaW5wdXQtc2xpZGVyXVtidWlsZGVyLWlucHV0LXN0ZXA9XCInICsgc3RlcCArICdcIl06Y2hlY2tlZCcpXG4gICAgICAsIGlucHV0cyA9IFtdXG4gICAgICAsIHggPSAwXG4gICAgICAsIG5hbWUgPSAnJ1xuICAgICAgLCBza3VcbiAgICAgICwgcGVyc29uYU9ialxuICAgICAgLCBhZGRJbmZvO1xuXG4gICAgICBzdGVwSW5wdXRzID0gd2luZG93LmZyZWVkb20ubm9kZUxpc3RUb0FycmF5KHN0ZXBJbnB1dHMpO1xuICAgICAgc3RlcFJhZGlvcyA9IHdpbmRvdy5mcmVlZG9tLm5vZGVMaXN0VG9BcnJheShzdGVwUmFkaW9zKTtcblxuICAgICAgaW5wdXRzID0gc3RlcElucHV0cy5jb25jYXQoc3RlcFJhZGlvcyk7XG4gICAgICB4ID0gaW5wdXRzLmxlbmd0aDtcblxuICAgICAgd2hpbGUoeC0tKSB7XG4gICAgICAgIHNrdSA9IGlucHV0c1t4XS5nZXRBdHRyaWJ1dGUoJ2J1aWxkZXItaW5wdXQtc2t1Jyk7XG4gICAgICAgIG5hbWUgPSBpbnB1dHNbeF0uZ2V0QXR0cmlidXRlKCdidWlsZGVyLWlucHV0LW5hbWUnKTtcblxuICAgICAgICBwZXJzb25hT2JqID0gZ2V0UGVyc29uYVZhbHVlKHNrdSwgc3RlcCk7XG4gICAgICAgIGFkZEluZm8gPSBnZXRBZGRpdGlvbmFsSW5mb3JtYXRpb24oc3RlcCk7XG5cbiAgICAgICAgaWYocGVyc29uYU9iaiAmJiBwZXJzb25hT2JqLnZhbHVlLnRyaW0oKSAhPT0gJycpIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKHBlcnNvbmFPYmosIGFkZEluZm8sIHtsYWJlbDogbmFtZX0pOyAvL21lcmdlIGluZm9ybWF0aW9uc1xuICAgICAgICAgIHBlcnNvbmFMaXN0LnB1c2gocGVyc29uYU9iaik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignYnVpbGRlci1mb3JtLmdldE11bHRPcHRpb25zUGVyc29uYUxpc3QnLCBlcnJvcik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHJldHVybiBwZXJzb25hTGlzdDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZnVuY3Rpb24gdG8gZ2V0IHRoZSBhZGRpdGlvbmFsIGluZm9ybWF0aW9ucyB0byBzZW5kIHRvIGNhcnRcbiAgICogQHBhcmFtIHtudW1iZXJ9IC0gc3RlcCB0byBnZXQgdGhlIGluZm9ybWF0aW9uXG4gICAqIEByZXR1cm4ge29iamVjdH0gLSBvYmplY3Qgb2YgYWRkaXRpb25hbCBpbmZvcm1hdGlvbnNcbiAgICovXG4gIGZ1bmN0aW9uIGdldEFkZGl0aW9uYWxJbmZvcm1hdGlvbihzdGVwKSB7XG4gICAgdmFyIGFkZGl0aW9uYWxPYmogPSB7fTtcbiAgICB0cnkge1xuICAgICAgdmFyIGJ1aWxkZXIgPSBzdG9yZS5nZXRTdGF0ZSgpLnBkcC5wZXJzb25hLmJ1aWxkZXIuYnVpbGRlckpzb247IC8vZ2V0IGZyb20gc3RvcmVcbiAgICAgIHZhciBzdGVwSnNvbiA9IGJ1aWxkZXIuc3RlcHNbc3RlcCAtIDFdO1xuXG4gICAgICBpZihzdGVwSnNvbikge1xuICAgICAgICBhZGRpdGlvbmFsT2JqWydjYXJ0SW1hZ2UnXSA9IHN0ZXBKc29uLmNhcnRJbWFnZTtcbiAgICAgICAgYWRkaXRpb25hbE9ialsncHJvZHVjdFR5cGUnXSA9IHN0ZXBKc29uLnByb2R1Y3RUeXBlO1xuICAgICAgICBhZGRpdGlvbmFsT2JqWydsYWJlbCddID0gc3RlcEpzb24ubGFiZWw7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2J1aWxkZXItZm9ybS5nZXRQZXJzb25hTGlzdCcsIGVycm9yKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgcmV0dXJuIGFkZGl0aW9uYWxPYmo7XG4gICAgfVxuICB9XG5cbiAgICAvKipcbiAgICogZnVuY3Rpb24gdG8gbWFuaXB1bGF0ZSB0aGUgcGVyc29uYSBmb3JtIHN0YXR1c1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHN0YXR1cyBzdGF0dXMgb2YgZm9ybSBwZXJzb25hIG9wZW5cbiAgICovXG4gIGZ1bmN0aW9uIGNoYW5nZVBlcnNvbmFPcGVuU3RhdHVzKHN0YXR1cykge1xuICAgIHRyeSB7XG4gICAgICBzdGF0ZS5wZXJzb25hT3BlbmVkID0gc3RhdHVzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdidWlsZGVyLWZvcm0uY2hhbmdlUGVyc29uYU9wZW5TdGF0dXMnLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIGZ1bmN0aW9uIHRvIHNhdmUgdGhlIHNlbGVjdGVkIHBlcnNvbmEgaW50byBzdG9yZVxuICAqL1xuICBmdW5jdGlvbiBzYXZlU2VsZWN0ZWRQZXJzb25hKCkge1xuICAgIHRyeSB7XG4gICAgICBpZihzdGF0ZS5wZXJzb25hT3BlbmVkKSB7XG4gICAgICAgIHZhciBwZXJzb25hU3RhdGUgPSB7XG4gICAgICAgICAgbGlzdDogZ2V0UGVyc29uYUxpc3QoKSxcbiAgICAgICAgICBzdGF0ZTogc3RhdGUucGVyc29uYU9wZW5lZFxuICAgICAgICB9O1xuXG4gICAgICAgIHN0b3JlLmRpc3BhdGNoKHN0b3JlLmFjdGlvblR5cGVzLkNIQU5HRV9TRUxFQ1RFRF9QRVJTT05BX0JVSUxERVIsIHBlcnNvbmFTdGF0ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdG9yZS5kaXNwYXRjaChzdG9yZS5hY3Rpb25UeXBlcy5DSEFOR0VfU0VMRUNURURfUEVSU09OQV9CVUlMREVSLCB7fSk7IC8vY2xlYXJcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignYnVpbGRlci1jb21iby5zYXZlU3RhdGUnLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgd2luZG93LmZyZWVkb20ubnNQdWJTdWIuc3ViKCdjb2xvckZsYXZvclNpemUuc2l6ZS5idXlFdmVudCcsIHNhdmVTZWxlY3RlZFBlcnNvbmEpO1xuICB3aW5kb3cuZnJlZWRvbS5uc1B1YlN1Yi5zdWIoJ3BlcnNvbmFsaXphdGlvbi5mb3JtLmNoYW5nZU9wZW5DbG9zZWQnLCBjaGFuZ2VQZXJzb25hT3BlblN0YXR1cyk7Ly91cGRhdGUgcGVyc29uYSBvcGVuL2Nsb3NlZFxuICB3aW5kb3cuZnJlZWRvbS5uc1B1YlN1Yi5zdWIoJ2J1aWxkZXIuYnVpbGRlci1jb21iby5jaGFuZ2VkJywgdmFsaWRhdGVTZWxlY3RCeUV2ZW50KTsvL3N1YnNjcmliZSBidWlsZGVyIGNvbWJvIGNoYW5nZSBldmVudFxuICB3aW5kb3cuZnJlZWRvbS5uc1B1YlN1Yi5zdWIoJ2J1aWxkZXIuY29sb3ItcmFkaW8uY2hhbmdlZCcsIHZhbGlkYXRlSW5wdXRCeUV2ZW50KTsvL3N1YnNjcmliZSBjb2xvciBjaGFuZ2UgZXZlbnRcbiAgd2luZG93LmZyZWVkb20ubnNQdWJTdWIuc3ViKCdidWlsZGVyLnNsaWRlci5jaGFuZ2VkJywgdmFsaWRhdGVJbnB1dEJ5RXZlbnQpOy8vc3Vic2NyaWJlIHNsaWRlciBjaGFuZ2UgZXZlbnRcbiAgd2luZG93LmZyZWVkb20ubnNQdWJTdWIuc3ViKCdidWlsZGVyLmlucHV0LmlucHV0ZWQnLCB2YWxpZGF0ZUlucHV0QnlFdmVudCk7Ly9zdWJzY3JpYmUgdGhlIGlucHV0IGlucHV0ZWQgZXZlbnRcbiAgd2luZG93LmZyZWVkb20ubnNQdWJTdWIuc3ViKCdidWlsZGVyLnBlcnNvbmFsaXphdGlvbi5nZXQnLCBnZXRQZXJzb25hTGlzdCk7Ly9jYWxsIHRvIGFjdGlvbiBjbGlja1xufSgpKTtcbiJdfQ==
